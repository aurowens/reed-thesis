---
header-includes:
- \usepackage{graphicx,latexsym}
- \usepackage{amssymb,amsthm,amsmath}
- \usepackage{longtable,booktabs,setspace}
- \usepackage{algorithm}
- \usepackage{algpseudocode}
- \usepackage{pifont}
output: pdf_document
---
```{r include_reedtemplates_4, include = FALSE}
# This chunk ensures that the reedtemplates package is installed and loaded
# This reedtemplates package includes the template files for the thesis and also
# two functions used for labeling and referencing
if(!require(devtools))
  install.packages("devtools", repos = "http://cran.rstudio.com")

if(!require(reedtemplates)){
  library(devtools)
  devtools::install_github("ismayc/reedtemplates")
  }
library(reedtemplates)

library(tree)
library(reedtemplates)
library(MASS)
library(ggplot2)
library(randomForest)
library(maptree)
library(knitr)
library(GGally)
library(reshape)
#flights <- read.csv("data/flights.csv")
thesis <- c("#245e67", "#90bd98", "#cfd0a0", "#c49e46", "#d28383")
```

```{r inftree,echo = FALSE, warning=FALSE, message=FALSE}
################INFTREES############
intervalReturn <- function(split.cutleft){ 
  intervals <- data.frame(split.cutleft)
  intervals <- filter(intervals, split.cutleft != "")
  intervals <- dplyr::select(intervals, split.cutleft)
  intervals$split.cutleft <- gsub("<", "", intervals$split.cutleft)
  intervals$split.cutleft <- as.numeric(intervals$split.cutleft)
  return(arrange(intervals, (split.cutleft)))
}

partitionCreator <- function(i, x, data) {
  p <- c(1:(1+nrow(i)))
  bins <- data.frame (bin = rep(1, nrow(data)), v = data[,x])
  for(j in 1:nrow(i)){
    bins[bins$v > i[j,1],1] <- p[j+ 1]
  }
  return(bins$bin)
}

condPermuter <- function(d2, x) {
  for(i in 1:length(unique(d2$p))){
    #set.seed(1)
    ifelse(length(d2[d2$p== i,x]) == 1, d2[d2$p == i, x], 
           d2[d2$p == i, x] <- sample(d2[d2$p== i,x]))
  }
  return(d2[,x])
}

VIdevBagged<- function(b, x){
  return(as.numeric(as.data.frame(b$mtrees[[1]]$btree$frame)[,c(1,4)] %>% filter(var == x) %>% dplyr::summarise(sum = sum(dev))))
}

VIdev<- function(t2, x){
  fr <- as.data.frame(t2$frame)[,c(1,3)]
  if ( x %in% fr$var){
    return(fr %>% dplyr::filter(var == x) %>% dplyr::summarise(sum = sum(dev)))
  } 
  return(0)
}

variable.importance.dev <- function(t1, x, d){
  if(length(t1$frame$splits[,1]) == 1) {
    return(VIdev(t1, x))
  } else {
    interval <- intervalReturn(t1$frame$splits[,1])
    d$p <- partitionCreator(interval, x, d)
    d[,x] <- condPermuter(d, x)
    t2 <- tree(y ~ ., data = d, y = TRUE)
    v1 <- VIdev(t2, x)
    #rm(t1, t2)
    return(v1)
  }
}

inftrees <- function(xs, data, n) {
  x <- names(xs)
  vi <- rep(0,length(x))
  vo <- rep(0, length(x))
  
  t0 <- tree(y~., data)
  
  set.seed(1)
  for(i in 1:length(x)){
    vo[i] <- VIdev(t0, x[i])
  }
     set.seed(1)
      for(i in 1:length(x)){
        form <- as.formula(paste(x[i], "~."))
        ti <- tree(form, xs)
        vi[i] <- variable.importance.dev(ti, x[i], data)
      }
  
  v <- data.frame("variable" = x, "inftree.variable.importance" = as.numeric(vi), "base.variable.importance" = as.numeric(vo))
  return(v)
}


```



```{r d3ch4, echo = FALSE}
w1 <- rnorm(1000)

w2 <- 2*log(abs(w1)) + rnorm(1000)

w3 <- 2*log(abs(w2)) + rnorm(1000)

w4 <- 2*log(abs(w3)) + rnorm(1000)

n <- 1000

rep(0, 8) -> mu #mean of each variable

diag(8) -> sigma #creates a 12 by 12 diagonal matrix with 1's down the diagonal

mvrnorm(n =n, mu = mu, Sigma = sigma) -> simw5w12

data.frame(w1,w2,w3,w4,simw5w12) -> d3
              
c("W1","W2","W3","W4","W5","W6", "W7","W8","W9","W10","W11","W12") -> names(d3)

rep(0, 1000) -> ys #init a vector of zeros
c(5,5,2,0,-5,-5,-2,0,0,0,0,0) -> bts 

rnorm(1000, mean = 0, sd = .5) -> e 

for( i in 1:1000){ #go row by row and create the ys based on the function of e, bts, and d3
ys[i] <- d3[i,1]*bts[1]+
    d3[i,2]*bts[2]+ 
    d3[i,3]*bts[3]+ 
    d3[i,4]*bts[4]+ 
    d3[i,5]*bts[5]+ 
    d3[i,6]*bts[6]+
    d3[i,7]*bts[7]+ 
    d3[i,8]*bts[8]+ 
    d3[i,9]*bts[9]+ 
    d3[i,10]*bts[10]+ 
    d3[i,11]*bts[11]+ 
    d3[i,12]*bts[12] +
    e[i]
}

d3$y <- ys

```
**TO DO**
- The code I wrote for inftrees only gives one value for inftrees, when 
- compare viz from all three rf variable importances on D3 

#INFTrees and INFforests Variable Importance
##Theory

While conditional variable importance (Strobl et al) conditionally permutes each variable given the structure signified by the model that predicts the response, $Y \sim X_1,...,X_i,...,X_p$, our method conditionally permutes each variable given the structure outlined in a new model with the variable of interest as the response, $X_i \sim X_1,...X_{i-1},X_{i+1},...X_p$. This is not the most straightforward process, as trees partition the sample space, however, in INFTrees these partitions on the variables $X_1,...X_{i-1},X_{i+1},...X_p$ are treated as psuedo partitions on the variable of interest, $X_i$. This is accomplished by first partitioning on the sample predictors $X_1,...X_{i-1},X_{i+1},...X_p$  and then infering the partitions on $X_i$. As a visualizaiton of this, lets return to the $D_{3}$ dataset discussed in chapter 2. 


####Figure __: A Tree of the Model $Y \sim \omega_1,.. \omega_4$

```{r,echo = FALSE, warning=FALSE, message=FALSE}
test <- sample(1000, 200)

d3lite <- round(d3,2)

d3lite <- dplyr::select(d3lite, W1, W2, W3, W4, y)

t1 <- tree(y~ W1+ W2 + W3 + W4, data = d3lite[-test,])
t1$frame$yval <- round(t1$frame$yval,2)
t1 <- prune.tree(t1, best = 5)
#find a way to plot this tree. error: "figure margins too large"???? >:(
plot(t1)
text(t1)
```

Lets say we are interested in the variable importance of $\omega_2$. Then using the conditional variable importance (Strobl et al)'s permutation scheme, we would first look at the partitions on $\omega_2$ from this tree. 

####Figure __. 

```{r,echo = FALSE, warning=FALSE, message=FALSE}
yhats <- predict(t1, d3lite[test,-5])
d3lite$group <- as.factor(yhats)
d3lite$group <- ifelse(d3lite$group == levels(d3lite$group)[1], "A",
                ifelse(d3lite$group == levels(d3lite$group)[2], "B",
                ifelse(d3lite$group == levels(d3lite$group)[3], "C",
                ifelse(d3lite$group == levels(d3lite$group)[4], "D", "E"))))
d3lite$ys <- yhats

library(ggplot2)
library(plotly)

ggplot(d3lite, aes(x=W2, y=W3, color = group)) +
  geom_point()+
  ggtitle("Partitions on the Predictor Space W2 from Y~W1,..,W4")+
  scale_color_manual(values = thesis)
```

Clearly, the values of $\omega_2$ are less important to the patitioning structure than the interations of $\omega_2$ and the other variables. 

####Figure__: 

```{r,echo = FALSE, warning=FALSE, message=FALSE}
dp <- d3lite

as <- filter(dp, group == "A")
as$W2 <- sample(as$W2)

dp[dp$group == "A",] <- as

ggplot(dp, aes(x=W2, y=W3, color = group)) +
  geom_point()+
  ggtitle("Partitions on the Predictor Space W2 from Y~W1,..,W4")+
  scale_color_manual(values = thesis)

```

Under the INFTrees method, before permuting, fit another tree to the model $\omega_2 \sim \omega_1, \omega_3, \omega_4$ 

####Figure ___: Tree of the model $\omega_2 \sim \omega_1, \omega_3, \omega_4$ 

```{r,echo = FALSE, warning=FALSE, message=FALSE}
t2 <- tree(W2 ~ W1 + W3 + W4, data = d3lite[-test,])
t2$frame$yval <- round(t2$frame$yval,2)
t2 <- prune.tree(t2, best = 5)
plot(t2)
text(t2)
```

The partitions on $\omega_2$ implied by this model are:


####Figure __. 

```{r,echo = FALSE, warning=FALSE, message=FALSE}
yhats <- predict(t2, d3lite[test,-5])
d3lite$group <- as.factor(yhats)
d3lite$group <- ifelse(d3lite$group == levels(d3lite$group)[1], "A",
                ifelse(d3lite$group == levels(d3lite$group)[2], "B",
                ifelse(d3lite$group == levels(d3lite$group)[3], "C",
                ifelse(d3lite$group == levels(d3lite$group)[4], "D", "E"))))
d3lite$ys <- yhats

library(ggplot2)
library(plotly)

ggplot(d3lite, aes(x=W2, y = W3, color = group)) +
  geom_point()+
  ggtitle("Partitions on the Predictor Space W2 from Y~W1,..,W4")+
  scale_color_manual(values = thesis)
```


####Figure ___ 

```{r,echo = FALSE, warning=FALSE, message=FALSE}
dp <- d3lite

as <- filter(dp, group == "A")
as$W2 <- sample(as$W2)

dp[dp$group == "A",] <- as

ggplot(dp, aes(x=W2, y=W3, color = group)) +
  geom_point()+
  ggtitle("Partitions on the Predictor Space W2 from W2~W1+W3+W4")+
  scale_color_manual(values = thesis)

```

**Need a better way to viz this**

###INFTrees

For a CART, $T$, representing the model $Y~X_1,...,X_p$ where $Y,X_1,...,X_p$ are vectors of length n, the INFTrees algorithm proceeds as follows:


\begin{algorithm}
\caption{INFTree, $VI_{inf}(T)$}
\label{inftree}
\begin{algorithmic}
\For{each $X_i \in {{X_1,...,X_p}}$}
\State Calculate: $\Phi_o =  RSS(T, (Y,X_1,..X_p))$
\State Fit the tree $T_{X_i}$, where $T_{X_i} : X_i \sim X_1,...,X_{i-1}, X_{i+1},...X_p$
\State Extract the set $P_{X_i}$ of partitions on $X_i$ from $T_{X_i}$
\State Permute $X_i$ with respect to $P_{X_i}$
\State Find $\Phi^* =  RSS(T, (Y,X_1,..., \bar{X_i},...X_p))$
\State Repeat the above procedure to find the distribution of $\Phi^*$
\State Test the null hypothesis that $\Phi_o$ is the likely value of $RSS(T, (Y,X_1,..X_p))$
\EndFor
\end{algorithmic}
\end{algorithm}

This procedure allows the null hypothesis that Y is independent of $X_i$ given the values of $X_1,...X_{i-1},X_{i+1},...X_p$ to be tested. Therefor, values of $VI_{inf}$ could be compared in a similar manner to the coefficients of linear regression. 

###INFForests

The algorithm for determining $VI_{inf}(R)$ follows similarly.

\begin{algorithm}
\caption{INFForests, $VI_{inf}(R)$}
\label{infforest}
\begin{algorithmic}[1]
\State Fit a random forest, $R$ on the dataset $D$ fitting the model $Y \sim X_1,...,X_p$.
\For{each $X_i \in {{X_1,...,X_p}}$}
\For{each $t \in R$}
\State Calculate: $\Xi_o =  \frac 1 {\nu_t} RSS(t,\bar{B}^t)$
\State Calculate a tree $T_i$ that predicts $X_i \sim X_1,...,X_{i-1}, X_{i+1},...X_p$ using the subset of the observations used to fit $t$  
\State Permute the subset of $X_i$ contained in $\bar{B}_t$ with respect to the set of partions $P_{xi}$ from $T_i$.
\State Now find $\Xi^* =  \frac 1 {\nu_t} RSS(t,\bar{B}_t^*)$
\State The difference between these values, $\Xi^* - \Xi_o$,  is the variable importance for $X_i$ on $t$
\EndFor
\State Test the null hypothesis that $\Xi_o$ is the likely value of $\frac 1 {\nu_t} RSS(t,\bar{B}_t^*)$ using the distribution of values of $\Xi^*$ gathered from each tree in $R$
\EndFor
\end{algorithmic}
\end{algorithm}


##Comparisons and Applications
###Trees 

```{r, cache=TRUE, echo = FALSE}
t <- tree(y ~., d3)
t$frame$yval <- round(t$frame$yval, 2)

inft <- inftrees(d3[,c(1:12)], d3)

inft$coefficients <- bts
kable(inft)

viW2<- rep(0,1000)
for( i in 1:1000){
  test <- sample(1000,200)
  data <-d3[-test,]
  viW2[i] <- inftrees(data[,c(1:12)], data)[2,2]
}
```

```{r}
viW2 <- as.data.frame(viW2)
ggplot(aes(x = viW2), data = viW2) + 
  geom_density(fill = thesis[1], alpha = .8) +
  ggtitle("Distribution of RSS when W2 is Conditionally Permuted")+
  geom_vline(xintercept = inft[2,3])
```

###Random Forests
